# TDL-GNSS
## Tightly Coupled Deep Learning and GNSS Integration Framework

This is a subsystem based on pyrtklib, which aims to tightly integrate deep learning into GNSS solving process. The preprint version of our paper can be obtained from [link](link).

There are several useful functions can be found in rtk_util.py, including a weight least squares process implemented by numpy and pytorch, which allow you to conventionally adjust the weight and pseudorange bias in solving. 

We also provide a dataset named KLT, including KLT1, KLT2 and KLT3 splitted by timestamp with the 100Hz ground truth generated by our ground truth collection platform. The data can be downloaded from [dropbox](https://www.dropbox.com/scl/fi/d3urwaquf5ema5j0unmt4/data.zip?rlkey=tuwpx9pdzqtdvoeoqwhcc5gi8&st=wh5qhg6e&dl=0). Download the data and extract it as data folder. For more details of the sensor kit, please refer to [UrbanNav](https://github.com/IPNL-POLYU/UrbanNavDataset). If you want more data from different sensors (For example, camera/LiDAR/IMU to make a multimodal achitechture), you can download the rosbag from [our dropbox folder](https://www.dropbox.com/scl/fo/qbijzmzr2iorsirwb902p/ADZzlbG8SLhG94VvnFSwIgg?rlkey=mup7s7ot1yg0qhwygdp4cxztw&st=l9s3lc44&dl=0)

## Framework
### Training
![Training Process](image/train_process.png)
This is the training process. In this demonstration, we provide a simple network achitechture, which uses C/N0, elevation angle and residual from the equal weight least squares solution. The predicted pseudorange and weight are then be used in the WLS to get the position. The loss function applys to the ground truth position and predicted position, and the loss is back propagated to train the network.

### Prediction
![Prediction Process](image/predict_process.png)
Just like the training process, in prediction process, the output of the WLS is the final position.

## Usage
There are three kinds of network architechture in this repository, which are:
* Bias Network: Only predict the bias correction of the pseudorange. The associated files are `bias_network_train.py` and `bias_network_predict.py`.
* Weight Network: Only predict the weight used in WLS. The associated files are `weight_network_train.py` and `weight_network_predict.py`.
* Hybrid Network: Both correct the pseudorange bias and predic the weight. The associated files are `hybrid_network_train.py` and `hybrid_network_predict.py`.

To train a network, you need to make a config file first. The config file is written in json. Here are the possible parameters:

* obs: This is the rinex observation file, it could be a file name or a list of file name.
* eph: The ephmeris files. It also can be a file name or a list of file name.
* gt: The ground truth file.
* start_time: An integer to indicate the start time of the rinex file. The time is aligned to gps time but in timestamp format.
* end_time: An integer to indicate the end time of the rinex file. The time is aligned to gps time but in timestamp format.
* model: The saving folder of the trained model.
* mode: Currently not used. Maybe in the future, there will be an unified interface.
* epoch: Only training will use this parameter. To specify the training epoch.

The examples can be found in config folder.

To train a model, use the following command:
`python {type}_train.py config.json`
To use a model to predict: use:
`python {type}_predict.py config.json`
The alternative types here are bias/weight/hybrid.
#### Examples
There are an example for hybrid network training and prediction.
```
python hybrid_network_train.py config/hybrid_share/klt3_train.json
python hybrid_network_predict.py config/hybrid_share/klt1_predict.json
```
### Baseline
We also provide a baseline script to generate the result from goGPS and RTKLIB. It can use the any prediction config file.
```
python3 baseline.py config/bias/klt2_predict.json
```
## Training Trick
1. All of the networks will first normalize the data, thus the model is related to the receiver. For example, using a ulox-F9P to collect data and train the model, the model maybe not works well on the data collected by a phone.

2. When training, be aware that do not give an initial guess of the position as (0,0,0), because this will lead the drastic changes in the H matrix. A solution from the equal weight least squares is ideal and reasonable.

3. And if you want to train a hybrid bias weight network, the training epoch should not be as much as bias only and weight only network, or it will overfit. The recommand training epochs on KLT3 is around 100.

## Citation
If you find this tool useful, it would be praciated to cite our paper:
```latex
{

}
```